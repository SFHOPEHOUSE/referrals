<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Travel Tracker — The Way Out SF</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --red:#C8102E;--red-dark:#A00D24;
    --blue:#1B3A5C;--blue-light:#24507A;
    --white:#FFFFFF;--bg:#F5F5F5;
    --text:#1A1A1A;--gray:#6B7280;
    --border:#D1D5DB;--radius:10px;
    --shadow:0 4px 24px rgba(0,0,0,.08);
  }
  body{
    font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:var(--bg);color:var(--text);line-height:1.5;
    min-height:100vh;display:flex;flex-direction:column;position:relative;
  }
  body::before{
    content:'';position:fixed;inset:0;z-index:-2;
    background:url('https://images.unsplash.com/photo-1501594907352-04cda38ebc29?w=1920&q=80') center/cover no-repeat;
  }
  body::after{
    content:'';position:fixed;inset:0;z-index:-1;
    background:linear-gradient(180deg,rgba(245,245,245,.88) 0%,rgba(245,245,245,.75) 40%,rgba(27,58,92,.55) 100%);
    backdrop-filter:blur(2px);
  }
  .logo-bar{
    background:rgba(255,255,255,.92);backdrop-filter:blur(12px);
    text-align:center;padding:1.5rem 1rem;
    border-bottom:1px solid rgba(255,255,255,.6);
  }
  .logo-bar img{max-width:480px;width:90%;height:auto}

  /* ── Card ── */
  .card{
    max-width:640px;width:100%;margin:1.5rem auto 2rem;
    border-radius:var(--radius);box-shadow:var(--shadow);
    padding:2rem 2rem 2.5rem;position:relative;
    backdrop-filter:blur(16px);background:rgba(255,255,255,.92);
    border:1px solid rgba(255,255,255,.7);
  }
  .card h2{
    font-family:'Calibri','Calibri Body',Candara,'Segoe UI',sans-serif;
    color:var(--white);font-size:1.1rem;font-weight:700;letter-spacing:.08em;
    margin:-2rem -2rem 1.75rem;padding:1.1rem 2rem;
    background:linear-gradient(135deg,var(--blue) 0%,var(--red) 50%,var(--blue) 100%);
    border-radius:var(--radius) var(--radius) 0 0;
    text-align:center;text-transform:uppercase;
    text-shadow:0 1px 3px rgba(0,0,0,.25);border-bottom:3px solid var(--red-dark);
  }

  /* ── Program Toggle (inside trip card) ── */
  .program-toggle{display:flex;gap:.5rem;margin-bottom:.9rem}
  .program-toggle input[type="radio"]{display:none}
  .program-toggle label{
    flex:1;text-align:center;padding:.55rem .5rem;
    border:2px solid var(--border);border-radius:7px;
    cursor:pointer;font-size:.82rem;font-weight:600;
    color:var(--gray);background:var(--white);transition:all .2s;user-select:none;
  }
  .program-toggle input:checked + label{
    border-color:var(--blue);background:var(--blue);color:var(--white);
    box-shadow:0 2px 6px rgba(27,58,92,.2);
  }
  .program-toggle label:hover{border-color:var(--blue);color:var(--blue)}
  .program-toggle input:checked + label:hover{color:var(--white)}
  .program-error{color:var(--red);font-size:.78rem;margin-top:-.5rem;margin-bottom:.7rem;display:none}
  .program-error.show{display:block}

  /* ── Section label ── */
  .section-label{
    color:var(--blue);font-size:.8rem;font-weight:700;
    text-transform:uppercase;letter-spacing:.06em;
    margin:1.75rem 0 .75rem;padding-bottom:.4rem;
    border-bottom:1.5px solid #E5E7EB;
  }

  /* ── Fields ── */
  .field{margin-bottom:1.1rem}
  label{display:block;font-size:.85rem;font-weight:600;color:var(--text);margin-bottom:.35rem}
  label .req{color:var(--red);margin-left:2px}
  input,textarea{
    width:100%;padding:.7rem .85rem;font-size:1rem;
    border:1.5px solid var(--border);border-radius:6px;
    outline:none;transition:border-color .2s,box-shadow .2s;
    background:var(--white);color:var(--text);font-family:inherit;
  }
  input:focus,textarea:focus{border-color:var(--red);box-shadow:0 0 0 3px rgba(200,16,46,.12)}
  input.invalid,textarea.invalid{border-color:var(--red);background:#FEF2F2}
  .error-msg{color:var(--red);font-size:.78rem;margin-top:.25rem;display:none}
  .error-msg.show{display:block}
  textarea{resize:vertical;min-height:80px}
  .row{display:flex;gap:1rem}
  .row .field{flex:1}

  /* ── Trip Card ── */
  .trip-card{
    border:1.5px solid var(--border);border-radius:8px;
    padding:1.1rem 1.1rem 1rem;margin-bottom:1rem;
    background:rgba(255,255,255,.6);
    transition:border-color .2s;
  }
  .trip-card:focus-within{border-color:rgba(200,16,46,.3)}

  .trip-header{
    display:flex;align-items:center;justify-content:space-between;
    margin-bottom:.9rem;
  }
  .trip-num{
    font-size:.8rem;font-weight:700;text-transform:uppercase;
    letter-spacing:.07em;color:var(--blue);
    display:flex;align-items:center;gap:.4rem;
  }
  .trip-num svg{width:14px;height:14px;opacity:.7}

  .remove-btn{
    display:inline-flex;align-items:center;gap:.3rem;
    font-size:.75rem;font-weight:600;color:var(--gray);
    background:none;border:1.5px solid var(--border);
    border-radius:5px;padding:.25rem .6rem;cursor:pointer;
    transition:all .15s;font-family:inherit;
  }
  .remove-btn:hover{color:var(--red);border-color:var(--red);background:#FEF2F2}

  /* ── Route button ── */
  .route-btn{
    display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
    width:100%;padding:.7rem;margin-top:.2rem;
    font-size:.88rem;font-weight:600;font-family:inherit;
    color:var(--white);background:var(--blue);
    border:none;border-radius:6px;cursor:pointer;transition:background .2s,transform .1s;
  }
  .route-btn:hover{background:var(--blue-light)}
  .route-btn:active{transform:scale(.98)}
  .route-btn:disabled{opacity:.6;cursor:not-allowed}
  .route-btn .spinner{
    width:15px;height:15px;
    border:2px solid rgba(255,255,255,.35);
    border-top-color:var(--white);border-radius:50%;
    animation:spin .6s linear infinite;display:none;
  }
  .route-btn.loading .spinner{display:block}
  .route-btn.loading .btn-text{display:none}

  /* ── Map ── */
  .map-wrap{
    margin-top:.85rem;border-radius:7px;
    overflow:hidden;border:1.5px solid var(--border);display:none;
  }
  .map-wrap .leaflet-map{height:210px;width:100%}

  /* ── Miles / route error ── */
  .miles-pill{
    display:none;margin-top:.6rem;padding:.55rem .9rem;
    background:#EFF6FF;border:1.5px solid #BFDBFE;
    border-radius:6px;font-size:.85rem;color:#1E40AF;
  }
  .miles-pill strong{font-weight:700}
  .route-err{
    display:none;margin-top:.5rem;padding:.5rem .8rem;
    background:#FEF2F2;border:1.5px solid #FCA5A5;
    border-radius:5px;font-size:.8rem;color:var(--red);
  }
  .route-err.show{display:block}
  .miles-pill.show{display:block}

  /* ── Add Stop button ── */
  .add-stop-btn{
    display:flex;align-items:center;justify-content:center;gap:.5rem;
    width:100%;padding:.7rem;
    font-size:.92rem;font-weight:600;font-family:inherit;
    color:var(--blue);background:transparent;
    border:2px dashed var(--border);border-radius:8px;
    cursor:pointer;transition:all .2s;margin-bottom:1.25rem;
  }
  .add-stop-btn:hover{border-color:var(--blue);background:rgba(27,58,92,.04)}

  /* ── Totals box ── */
  .totals-box{
    display:none;
    background:linear-gradient(135deg,rgba(27,58,92,.07),rgba(200,16,46,.05));
    border:1.5px solid rgba(27,58,92,.18);
    border-radius:8px;padding:1rem 1.1rem;margin-bottom:1rem;
  }
  .totals-box.show{display:block}
  .totals-box .totals-title{
    font-size:.75rem;font-weight:700;text-transform:uppercase;
    letter-spacing:.06em;color:var(--blue);margin-bottom:.6rem;
  }
  .totals-grid{display:flex;gap:1.5rem;flex-wrap:wrap}
  .totals-item .tl{font-size:.72rem;color:var(--gray);font-weight:500}
  .totals-item .tv{font-size:1.25rem;font-weight:700;color:var(--red);font-variant-numeric:tabular-nums}
  .totals-item .tv.blue{color:var(--blue)}

  /* ── Upload zone ── */
  .upload-zone{
    border:2px dashed var(--border);border-radius:8px;
    padding:1.25rem 1rem;text-align:center;cursor:pointer;
    transition:border-color .2s,background .2s;
    background:var(--white);position:relative;
  }
  .upload-zone:hover,.upload-zone.dragover{
    border-color:var(--blue);background:rgba(27,58,92,.03);
  }
  .upload-zone input[type="file"]{
    position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;
  }
  .upload-zone .uz-icon{color:var(--gray);margin-bottom:.4rem}
  .upload-zone .uz-icon svg{width:28px;height:28px}
  .upload-zone .uz-label{font-size:.85rem;font-weight:600;color:var(--blue)}
  .upload-zone .uz-sub{font-size:.75rem;color:var(--gray);margin-top:.2rem}


  /* ── Submit button ── */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
    width:100%;padding:.9rem;margin-top:.25rem;
    font-size:1rem;font-weight:600;font-family:inherit;
    color:var(--white);background:var(--red);
    border:none;border-radius:6px;cursor:pointer;transition:background .2s,transform .1s;
  }
  .btn:hover{background:var(--red-dark)}
  .btn:active{transform:scale(.98)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn .spinner{
    width:18px;height:18px;
    border:2.5px solid rgba(255,255,255,.3);
    border-top-color:var(--white);border-radius:50%;
    animation:spin .6s linear infinite;display:none;
  }
  .btn.loading .spinner{display:block}
  .btn.loading .btn-text{display:none}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ── Overlay ── */
  .overlay{
    position:absolute;inset:0;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:rgba(255,255,255,.97);border-radius:var(--radius);
    opacity:0;pointer-events:none;transition:opacity .35s;padding:2rem;text-align:center;
  }
  .overlay.visible{opacity:1;pointer-events:auto}
  .overlay .icon{
    width:64px;height:64px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    margin-bottom:1rem;animation:pop .4s ease;
  }
  .overlay .icon.success{background:#DEF7EC;color:#059669}
  .overlay .icon.failure{background:#FEE2E2;color:var(--red)}
  .overlay .icon svg{width:32px;height:32px}
  .overlay h3{font-size:1.2rem;margin-bottom:.35rem}
  .overlay p{color:var(--gray);font-size:.9rem;max-width:360px}
  .overlay .btn-reset{margin-top:1.25rem;padding:.55rem 1.5rem;font-size:.88rem;width:auto;background:var(--blue)}
  .overlay .btn-reset:hover{background:var(--blue-light)}
  @keyframes pop{0%{transform:scale(0)}60%{transform:scale(1.15)}100%{transform:scale(1)}}

  .footer{text-align:center;padding:1.5rem 1rem;font-size:.78rem;color:var(--gray);margin-top:auto}

  /* ── Responsive ── */
  @media(max-width:600px){
    .logo-bar{padding:.75rem .5rem}
    .logo-bar img{max-width:260px}
    .card{margin:.5rem .5rem 1rem;padding:1.25rem 1rem 1.75rem}
    .card h2{margin:-1.25rem -1rem 1.25rem;padding:.9rem 1rem;font-size:.95rem}

    /* Keep date + staff name side by side, smaller */
    .row{display:flex;flex-direction:row;gap:.5rem}
    .row input{padding:.5rem .55rem;font-size:.92rem}
    .row label{font-size:.78rem}

    /* Compact all inputs on mobile */
    input,textarea{padding:.55rem .7rem;font-size:1rem}

    .leaflet-map{height:185px !important}
    .btn,.route-btn{padding:1rem}
    .footer{font-size:.72rem;padding:1rem .75rem}
  }
  @media(max-width:380px){
    .logo-bar img{max-width:220px}
    .card{margin:.25rem .25rem .75rem;padding:1rem .85rem 1.5rem}
    .row{gap:.35rem}
    .row input{font-size:.85rem;padding:.45rem .45rem}
    .leaflet-map{height:160px !important}
  }
</style>
</head>
<body>

<div class="logo-bar">
  <img src="thewayout-logo.png" alt="The Way Out — The Salvation Army">
</div>

<main class="card" id="card">
  <h2>Staff Travel Tracker</h2>

  <form id="travelForm" novalidate>

    <!-- Date & Staff -->
    <div class="section-label">Staff Details</div>
    <div class="row">
      <div class="field">
        <label for="tripDate">Date <span class="req">*</span></label>
        <input type="date" id="tripDate" name="tripDate" required>
        <div class="error-msg" id="err-tripDate">Please select the date.</div>
      </div>
      <div class="field">
        <label for="staffName">Staff Name <span class="req">*</span></label>
        <input type="text" id="staffName" name="staffName" placeholder="Full name" required autocomplete="name">
        <div class="error-msg" id="err-staffName">Please enter the staff name.</div>
      </div>
    </div>

    <!-- Trips -->
    <div class="section-label">Trips</div>
    <div id="tripList"></div>

    <button type="button" class="add-stop-btn" id="addStopBtn" onclick="addTrip()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Another Stop
    </button>

    <!-- Totals -->
    <div class="totals-box" id="totalsBox">
      <div class="totals-title">Day Total</div>
      <div class="totals-grid">
        <div class="totals-item">
          <div class="tl">Total Miles</div>
          <div class="tv blue" id="totalMilesDisplay">0.00</div>
        </div>
        <div class="totals-item">
          <div class="tl">Estimated Reimbursement</div>
          <div class="tv" id="totalReimbDisplay">$0.00</div>
        </div>
        <div class="totals-item">
          <div class="tl">Rate</div>
          <div class="tv" style="font-size:.95rem;color:var(--gray)">$0.72 / mile</div>
        </div>
      </div>
    </div>

    <!-- Additional Details -->
    <div class="section-label">Additional Details</div>

    <div class="field">
      <label for="tripPurpose">Purpose of Trip(s) <span class="req">*</span></label>
      <textarea id="tripPurpose" name="tripPurpose" style="min-height:75px"
        placeholder="Describe the reason for today's trips (e.g. Client transport, supply pickup, site visits...)" required></textarea>
      <div class="error-msg" id="err-tripPurpose">Please describe the purpose of the trip.</div>
    </div>

    <div class="field">
      <label for="vehicleIssues">Vehicle Issues</label>
      <textarea id="vehicleIssues" name="vehicleIssues" style="min-height:65px"
        placeholder="Describe any problems noticed (e.g. warning lights, damage, low fluids). Leave blank if none."></textarea>
    </div>

    <div class="field">
      <label>Toll &amp; Parking Receipts <span style="color:var(--gray);font-weight:400">(optional)</span></label>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="receiptFiles" accept="image/*" multiple>
        <div class="uz-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
        </div>
        <div class="uz-label">Tap to take photo or choose from library</div>
        <div class="uz-sub">Toll receipts, parking tickets &nbsp;·&nbsp; JPG / PNG</div>
      </div>
      <div id="receiptList"></div>
    </div>

    <div class="error-msg show" id="err-noRoute" style="display:none;margin-bottom:.5rem;font-size:.82rem"></div>

    <button type="submit" class="btn" id="submitBtn">
      <span class="btn-text">Submit Trip Log</span>
      <span class="spinner"></span>
    </button>
  </form>

  <!-- Success overlay -->
  <div class="overlay" id="successOverlay">
    <div class="icon success">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <h3>Trip Logged</h3>
    <p id="successMsg">Your trips have been recorded.</p>
    <button class="btn btn-reset" onclick="resetForm()">Log Another Day</button>
  </div>

  <!-- Error overlay -->
  <div class="overlay" id="errorOverlay">
    <div class="icon failure">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>
    <h3>Submission Failed</h3>
    <p id="errorMsg">Something went wrong. Please try again.</p>
    <button class="btn btn-reset" onclick="hideOverlays()">Try Again</button>
  </div>
</main>

<footer class="footer">
  &copy; 2026 The Way Out SF &mdash; The Salvation Army &nbsp;|&nbsp;
  Map data &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" style="color:inherit">OpenStreetMap</a> contributors
</footer>

<script>
// ── CONFIG ──────────────────────────────────────────────────
const FLOW_URLS = {
  'Hope House':  'PASTE_HOPE_HOUSE_FLOW_URL_HERE',
  'Wells Place': 'PASTE_WELLS_PLACE_FLOW_URL_HERE',
};
const RATE = 0.72;
// ────────────────────────────────────────────────────────────

const form = document.getElementById('travelForm');
const btn  = document.getElementById('submitBtn');

let tripCounter = 0;
const maps      = {};   // maps[id] = Leaflet map instance
const layers    = {};   // layers[id] = Leaflet layer group
const milesData = {};   // milesData[id] = { miles, duration }

// Set default date
document.getElementById('tripDate').valueAsDate = new Date();

// Start with one trip
addTrip();

// ── Add a trip card ──
function addTrip() {
  if (Object.keys(milesData).length >= 10) return; // reasonable max
  tripCounter++;
  const id = tripCounter;
  const allTrips = document.querySelectorAll('.trip-card');
  const num = allTrips.length + 1;

  const card = document.createElement('div');
  card.className = 'trip-card';
  card.id = 'trip-' + id;
  card.dataset.id = id;
  card.innerHTML = `
    <div class="trip-header">
      <span class="trip-num">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M2 12h3M19 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg>
        Trip ${num}
      </span>
      <button type="button" class="remove-btn" id="removebtn-${id}" onclick="removeTrip(${id})">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        Remove
      </button>
    </div>
    <div class="field">
      <label>Program <span class="req">*</span></label>
      <div class="program-toggle">
        <input type="radio" name="program-${id}" id="prog-hope-${id}" value="Hope House">
        <label for="prog-hope-${id}">Hope House</label>
        <input type="radio" name="program-${id}" id="prog-wells-${id}" value="Wells Place">
        <label for="prog-wells-${id}">Wells Place</label>
      </div>
      <div class="program-error" id="err-program-${id}">Please select a program.</div>
    </div>
    <div class="field">
      <label for="start-${id}">Starting Address <span class="req">*</span></label>
      <input type="text" id="start-${id}" placeholder="123 Main St, San Francisco, CA" autocomplete="street-address">
      <div class="error-msg" id="err-start-${id}">Please enter the starting address.</div>
    </div>
    <div class="field">
      <label for="dest-${id}">Destination Address <span class="req">*</span></label>
      <input type="text" id="dest-${id}" placeholder="456 Market St, San Francisco, CA" autocomplete="off">
      <div class="error-msg" id="err-dest-${id}">Please enter the destination address.</div>
    </div>
    <button type="button" class="route-btn" id="routebtn-${id}" onclick="calculateRoute(${id})">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18M13 6l6 6-6 6"/></svg>
      <span class="btn-text">Get Driving Distance &amp; Map</span>
      <span class="spinner"></span>
    </button>
    <div class="route-err" id="routeErr-${id}"></div>
    <div class="map-wrap" id="mapWrap-${id}">
      <div id="map-${id}" class="leaflet-map"></div>
    </div>
    <div class="miles-pill" id="milesPill-${id}"></div>
  `;

  document.getElementById('tripList').appendChild(card);
  updateRemoveButtons();

  // Clear input errors on typing
  card.querySelectorAll('input').forEach(inp => {
    inp.addEventListener('input', () => {
      const errEl = document.getElementById('err-' + inp.id);
      if (errEl) { errEl.classList.remove('show'); inp.classList.remove('invalid'); }
    });
  });
}

// ── Remove a trip card ──
function removeTrip(id) {
  const card = document.getElementById('trip-' + id);
  if (!card) return;
  if (maps[id]) { maps[id].remove(); delete maps[id]; }
  if (layers[id]) delete layers[id];
  delete milesData[id];
  card.remove();
  renumberTrips();
  updateRemoveButtons();
  updateTotals();
}

// ── Renumber trip headers after removal ──
function renumberTrips() {
  document.querySelectorAll('.trip-card').forEach((card, i) => {
    const numEl = card.querySelector('.trip-num');
    if (numEl) numEl.lastChild.textContent = ' Trip ' + (i + 1);
  });
}

// ── Show/hide remove buttons (hide when only 1 trip) ──
function updateRemoveButtons() {
  const cards = document.querySelectorAll('.trip-card');
  cards.forEach(card => {
    const btn = card.querySelector('.remove-btn');
    if (btn) btn.style.display = cards.length === 1 ? 'none' : 'inline-flex';
  });
}

// ── Geocode via Nominatim ──
async function geocode(address) {
  const res  = await fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(address), { headers:{'Accept-Language':'en-US,en'} });
  const data = await res.json();
  if (!data.length) throw new Error('Address not found: "' + address + '"');
  return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
}

// ── Route via OSRM ──
async function getRoute(s, e) {
  const res  = await fetch('https://router.project-osrm.org/route/v1/driving/' + s.lng + ',' + s.lat + ';' + e.lng + ',' + e.lat + '?overview=full&geometries=geojson');
  const data = await res.json();
  if (data.code !== 'Ok' || !data.routes.length) throw new Error('Could not calculate driving route.');
  return data.routes[0];
}

// ── Calculate route for one trip card ──
async function calculateRoute(id) {
  const startVal = (document.getElementById('start-' + id) || {}).value?.trim();
  const destVal  = (document.getElementById('dest-'  + id) || {}).value?.trim();
  const errEl    = document.getElementById('routeErr-' + id);
  const routeBtn = document.getElementById('routebtn-' + id);

  errEl.classList.remove('show');

  if (!startVal || !destVal) {
    errEl.textContent = 'Enter both addresses first.';
    errEl.classList.add('show');
    return;
  }

  routeBtn.classList.add('loading');
  routeBtn.disabled = true;

  try {
    const [sc, ec] = await Promise.all([geocode(startVal), geocode(destVal)]);
    const route    = await getRoute(sc, ec);

    const miles = (route.distance * 0.000621371).toFixed(2);
    const mins  = Math.round(route.duration / 60);
    const hrs   = Math.floor(mins / 60);
    const durStr = hrs > 0 ? hrs + ' hr ' + (mins % 60) + ' min' : mins + ' min';

    milesData[id] = { miles: parseFloat(miles), duration: durStr, start: startVal, dest: destVal };

    // Miles pill
    const pill = document.getElementById('milesPill-' + id);
    pill.innerHTML = '<strong>' + miles + ' miles</strong> &nbsp;·&nbsp; ~' + durStr + ' driving';
    pill.classList.add('show');

    // Map
    const mapWrap = document.getElementById('mapWrap-' + id);
    mapWrap.style.display = 'block';

    if (!maps[id]) {
      maps[id] = L.map('map-' + id, { zoomControl: true, scrollWheelZoom: false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
      }).addTo(maps[id]);
    }
    if (layers[id]) { maps[id].removeLayer(layers[id]); }
    layers[id] = L.layerGroup().addTo(maps[id]);

    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
    L.polyline(coords, { color: '#C8102E', weight: 4, opacity: 0.85 }).addTo(layers[id]);

    const mkStart = L.divIcon({ className:'', html:'<div style="background:#059669;width:13px;height:13px;border-radius:50%;border:2.5px solid white;box-shadow:0 1px 4px rgba(0,0,0,.4)"></div>', iconSize:[13,13], iconAnchor:[6,6] });
    const mkEnd   = L.divIcon({ className:'', html:'<div style="background:#C8102E;width:13px;height:13px;border-radius:50%;border:2.5px solid white;box-shadow:0 1px 4px rgba(0,0,0,.4)"></div>', iconSize:[13,13], iconAnchor:[6,6] });
    L.marker([sc.lat, sc.lng], { icon: mkStart }).bindPopup('<b>Start</b><br>' + startVal).addTo(layers[id]);
    L.marker([ec.lat, ec.lng], { icon: mkEnd   }).bindPopup('<b>Destination</b><br>' + destVal).addTo(layers[id]);

    maps[id].fitBounds(L.polyline(coords).getBounds(), { padding: [20, 20] });
    setTimeout(() => maps[id].invalidateSize(), 120);

    updateTotals();

  } catch (err) {
    errEl.textContent = err.message || 'Could not calculate route. Check the addresses and try again.';
    errEl.classList.add('show');
  } finally {
    routeBtn.classList.remove('loading');
    routeBtn.disabled = false;
  }
}

// ── Update total miles & reimbursement ──
function updateTotals() {
  const ids    = Object.keys(milesData);
  const total  = ids.reduce((sum, id) => sum + milesData[id].miles, 0);
  const reimb  = (total * RATE).toFixed(2);
  const box    = document.getElementById('totalsBox');

  if (ids.length > 0) {
    document.getElementById('totalMilesDisplay').textContent = total.toFixed(2);
    document.getElementById('totalReimbDisplay').textContent = '$' + reimb;
    box.classList.add('show');
  } else {
    box.classList.remove('show');
  }
}

// ── Receipt image handling ──
const receiptImages = []; // { name, base64, amount }
let receiptIdx = 0;

document.getElementById('receiptFiles').addEventListener('change', function() {
  Array.from(this.files).forEach(file => compressAndStore(file));
  this.value = '';
});

const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault(); uploadZone.classList.remove('dragover');
  Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/')).forEach(compressAndStore);
});

function compressAndStore(file) {
  const reader = new FileReader();
  reader.onload = evt => {
    const img = new Image();
    img.onload = () => {
      const MAX = 1100;
      let w = img.width, h = img.height;
      if (w > MAX || h > MAX) {
        if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
        else        { w = Math.round(w * MAX / h); h = MAX; }
      }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const base64 = canvas.toDataURL('image/jpeg', 0.78).split(',')[1];
      const id = receiptIdx++;
      receiptImages[id] = { name: file.name, base64, amount: '' };
      addReceiptRow(id, file.name, base64);
    };
    img.src = evt.target.result;
  };
  reader.readAsDataURL(file);
}

function addReceiptRow(id, name, base64) {
  const list = document.getElementById('receiptList');
  const row  = document.createElement('div');
  row.id = 'receipt-row-' + id;
  row.style.cssText = 'display:flex;align-items:center;gap:.65rem;margin-top:.65rem;padding:.6rem .75rem;background:#F9FAFB;border:1.5px solid var(--border);border-radius:8px;';
  row.innerHTML = `
    <img src="data:image/jpeg;base64,${base64}" alt="${name}"
      style="width:54px;height:54px;object-fit:cover;border-radius:6px;border:1px solid var(--border);flex-shrink:0;cursor:pointer;"
      onclick="viewReceipt(${id})">
    <div style="flex:1;min-width:0">
      <div style="font-size:.78rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:.35rem">${name}</div>
      <div style="display:flex;align-items:center;gap:.3rem">
        <span style="font-size:.85rem;font-weight:600;color:var(--gray)">$</span>
        <input type="number" min="0" step="0.01" placeholder="0.00" inputmode="decimal"
          id="amount-${id}"
          style="width:90px;padding:.35rem .5rem;font-size:.9rem;border:1.5px solid var(--border);border-radius:5px;outline:none;"
          oninput="receiptImages[${id}].amount=this.value"
          onfocus="this.style.borderColor='var(--red)'"
          onblur="this.style.borderColor='var(--border)'">
        <span style="font-size:.75rem;color:var(--gray)">amount paid</span>
      </div>
    </div>
    <button type="button" onclick="removeReceipt(${id})"
      style="flex-shrink:0;background:none;border:1.5px solid var(--border);border-radius:5px;padding:.3rem .5rem;cursor:pointer;color:var(--gray);font-size:.75rem;font-weight:600;"
      onmouseover="this.style.borderColor='var(--red)';this.style.color='var(--red)'"
      onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--gray)'">Remove</button>
  `;
  list.appendChild(row);
}

function removeReceipt(id) {
  receiptImages[id] = null;
  const el = document.getElementById('receipt-row-' + id);
  if (el) el.remove();
}

function viewReceipt(id) {
  const r = receiptImages[id];
  if (!r) return;
  const w = window.open('');
  w.document.write('<img src="data:image/jpeg;base64,' + r.base64 + '" style="max-width:100%;height:auto">');
}

// ── Field error helpers ──
function showErr(id, show, msg) {
  const el  = document.getElementById('err-' + id);
  const inp = document.getElementById(id);
  if (!el || !inp) return;
  if (msg) el.textContent = msg;
  el.classList.toggle('show', show);
  inp.classList.toggle('invalid', show);
}

// ── Validate all ──
function validate() {
  let ok = true;

  // Date & name
  ['tripDate','staffName'].forEach(id => {
    const empty = !document.getElementById(id).value.trim();
    showErr(id, empty);
    if (empty) ok = false;
  });

  // Each trip card
  document.querySelectorAll('.trip-card').forEach(card => {
    const id = card.dataset.id;

    // Program per trip
    const prog    = document.querySelector('input[name="program-' + id + '"]:checked');
    const progErr = document.getElementById('err-program-' + id);
    if (!prog) { progErr.classList.add('show'); ok = false; }
    else        { progErr.classList.remove('show'); }

    const startEl = document.getElementById('start-' + id);
    const destEl  = document.getElementById('dest-'  + id);
    const noStart = !startEl.value.trim();
    const noDest  = !destEl.value.trim();
    const errS    = document.getElementById('err-start-' + id);
    const errD    = document.getElementById('err-dest-'  + id);

    if (noStart) { startEl.classList.add('invalid'); errS.classList.add('show'); ok = false; }
    if (noDest)  { destEl.classList.add('invalid');  errD.classList.add('show'); ok = false; }

    // Must have calculated route
    if (!milesData[id] && !noStart && !noDest) {
      const re = document.getElementById('routeErr-' + id);
      re.textContent = 'Please calculate the route before submitting.';
      re.classList.add('show');
      ok = false;
    }
  });

  // Purpose
  const purposeEmpty = !document.getElementById('tripPurpose').value.trim();
  showErr('tripPurpose', purposeEmpty);
  if (purposeEmpty) ok = false;

  return ok;
}

// ── Submit ──
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!validate()) return;

  btn.classList.add('loading');
  btn.disabled = true;

  // Build trip list with per-trip program
  const cards = document.querySelectorAll('.trip-card');
  const tripList = Array.from(cards).map((card, i) => {
    const id   = card.dataset.id;
    const d    = milesData[id] || {};
    const prog = (document.querySelector('input[name="program-' + id + '"]:checked') || {}).value || '';
    return {
      tripNumber:         i + 1,
      program:            prog,
      startingAddress:    (document.getElementById('start-' + id) || {}).value?.trim() || '',
      destinationAddress: (document.getElementById('dest-'  + id) || {}).value?.trim() || '',
      miles:              d.miles || 0,
      duration:           d.duration || '',
    };
  });

  const totalMiles = tripList.reduce((s, t) => s + t.miles, 0);
  const totalReim  = (totalMiles * RATE).toFixed(2);
  const tripDate   = document.getElementById('tripDate').value;
  const staffName  = document.getElementById('staffName').value.trim();
  const purpose    = document.getElementById('tripPurpose').value.trim();
  const submittedAt = new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });

  // Group trips by program and send to each program's flow
  const byProgram = {};
  tripList.forEach(t => {
    if (!byProgram[t.program]) byProgram[t.program] = [];
    byProgram[t.program].push(t);
  });

  const sends = Object.entries(byProgram).map(([prog, progTrips]) => {
    const flowUrl = FLOW_URLS[prog];
    if (!flowUrl || flowUrl.startsWith('PASTE_')) return Promise.resolve();
    const progMiles = progTrips.reduce((s, t) => s + t.miles, 0);
    const payload = {
      program:                prog,
      tripDate,
      staffName,
      trips:                  progTrips,
      totalMiles:             parseFloat(progMiles.toFixed(2)),
      estimatedReimbursement: (progMiles * RATE).toFixed(2),
      purposeOfTrip:          purpose,
      vehicleIssues:          document.getElementById('vehicleIssues').value.trim() || 'None reported',
      receipts:               receiptImages.filter(Boolean).map(r => ({ name: r.name, data: r.base64 })),
      submittedAt,
    };
    return new Promise(resolve => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', flowUrl, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onreadystatechange = () => { if (xhr.readyState === 4) resolve(); };
      xhr.onerror = () => resolve();
      setTimeout(resolve, 6000);
      xhr.send(JSON.stringify(payload));
    });
  });

  try {
    await Promise.all(sends);
    const programs = [...new Set(tripList.map(t => t.program))].join(' & ');
    document.getElementById('successMsg').textContent =
      tripList.length + ' trip' + (tripList.length > 1 ? 's' : '') + ' logged for ' + programs +
      ' — ' + totalMiles.toFixed(2) + ' total miles. Estimated reimbursement: $' + totalReim + '.';
    showOverlay('successOverlay');
  } catch {
    document.getElementById('errorMsg').textContent = 'Network error — check your connection and try again.';
    showOverlay('errorOverlay');
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
});

function showOverlay(id) { document.getElementById(id).classList.add('visible'); }
function hideOverlays()  { document.querySelectorAll('.overlay').forEach(o => o.classList.remove('visible')); }

function resetForm() {
  hideOverlays();
  form.reset();
  document.getElementById('tripDate').valueAsDate = new Date();

  // Destroy all maps
  Object.keys(maps).forEach(id => { if (maps[id]) maps[id].remove(); });
  Object.keys(maps).forEach(id => delete maps[id]);
  Object.keys(layers).forEach(id => delete layers[id]);
  Object.keys(milesData).forEach(id => delete milesData[id]);

  // Clear trip list and add one fresh
  document.getElementById('tripList').innerHTML = '';
  tripCounter = 0;
  document.getElementById('totalsBox').classList.remove('show');
  receiptImages.length = 0;
  receiptIdx = 0;
  document.getElementById('receiptList').innerHTML = '';
  addTrip();
}
</script>
</body>
</html>
